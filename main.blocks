<xml xmlns="https://developers.google.com/blockly/xml"><block type="pxt-on-start" id="8wP)wM0+685*osT?#_,)" x="0" y="0"><statement name="HANDLER"><block type="typescript_statement" id="z;t.}iySr[:*;=oCGV=P" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace weatherSensors {" line1="    export let AHT20_I2C_ADDR = 0x38; // Dirección I2C del AHT20" line2="    export let BMP280_I2C_ADDR = 0x76; // Dirección I2C del BMP280" line3="    export let seaLevelhPa: number = 101325; // Presión estándar al nivel del mar en Pascales" line4="" line5="    // Estado de inicialización para evitar re-inicializaciones innecesarias" line6="    export let isAHT20Initialized = false;" line7="    export let isBMP280Initialized = false;" line8="" line9="    /**" line10="     * Inicializa el sensor AHT20." line11="     */" line12="    //% block=&quot;initialize AHT20&quot;" line13="    //% weight=100" line14="    //% group=&quot;Configuration&quot;" line15="    export function initAHT20() {" line16="        if (!isAHT20Initialized) {" line17="            let initCmd = pins.createBuffer(3);" line18="            initCmd[0] = 0xE1; // Comando de inicialización" line19="            initCmd[1] = 0x08;" line20="            initCmd[2] = 0x00;" line21="            pins.i2cWriteBuffer(AHT20_I2C_ADDR, initCmd, false);" line22="            basic.pause(10);" line23="            isAHT20Initialized = true;" line24="        }" line25="    }" line26="" line27="    /**" line28="     * Inicializa el sensor BMP280." line29="     */" line30="    //% block=&quot;initialize BMP280&quot;" line31="    //% weight=100" line32="    //% group=&quot;Configuration&quot;" line33="    export function initBMP280() {" line34="        if (!isBMP280Initialized) {" line35="            let ctrlMeas = pins.createBuffer(2);" line36="            ctrlMeas[0] = 0xF4; // Dirección del registro de control de medición" line37="            ctrlMeas[1] = 0x27; // 00100111: modo normal, oversampling x1" line38="            pins.i2cWriteBuffer(BMP280_I2C_ADDR, ctrlMeas, false);" line39="            let config = pins.createBuffer(2);" line40="            config[0] = 0xF5; // Dirección del registro de configuración" line41="            config[1] = 0xA0; // 10100000: filtro off, standby time 1000 ms" line42="            pins.i2cWriteBuffer(BMP280_I2C_ADDR, config, false);" line43="            basic.pause(100);" line44="            isBMP280Initialized = true;" line45="        }" line46="    }" line47="" line48="    /**" line49="     * Lee la temperatura del AHT20 en grados Celsius." line50="     */" line51="    //% block=&quot;read temperature from AHT20&quot;" line52="    //% weight=90" line53="    //% group=&quot;Sensors&quot;" line54="    export function readTemperature(): number {" line55="        initAHT20();" line56="        let buffer = pins.i2cReadBuffer(AHT20_I2C_ADDR, 6, false);" line57="        let temperature = -40 + ((buffer[3] &amp; 0xFF) &lt;&lt; 8 | (buffer[4] &amp; 0xFF)) * 0.02;" line58="        return temperature;" line59="    }" line60="" line61="    /**" line62="     * Lee la humedad del AHT20 en porcentaje." line63="     */" line64="    //% block=&quot;read humidity from AHT20&quot;" line65="    //% weight=85" line66="    //% group=&quot;Sensors&quot;" line67="    export function readHumidity(): number {" line68="        initAHT20();" line69="        let buffer2 = pins.i2cReadBuffer(AHT20_I2C_ADDR, 6, false);" line70="        let humidity = ((buffer2[1] &amp; 0xFF) &lt;&lt; 8 | (buffer2[2] &amp; 0xFF)) * 0.0244;" line71="        return humidity;" line72="    }" line73="" line74="    /**" line75="     * Lee la presión del BMP280 en Pascales." line76="     */" line77="    //% block=&quot;read pressure from BMP280&quot;" line78="    //% weight=80" line79="    //% group=&quot;Sensors&quot;" line80="    export function readPressure(): number {" line81="        initBMP280();" line82="        let buffer3 = pins.i2cReadBuffer(BMP280_I2C_ADDR, 3, false);" line83="        let pressure = ((buffer3[0] &amp; 0xFF) &lt;&lt; 12 | (buffer3[1] &amp; 0xFF) &lt;&lt; 4 | (buffer3[2] &amp; 0xFF) &gt;&gt; 4);" line84="        return pressure;" line85="    }" line86="" line87="    /**" line88="     * Calcula la altitud basada en la presión del BMP280 en metros." line89="     */" line90="    //% block=&quot;calculate altitude from BMP280 pressure&quot;" line91="    //% weight=75" line92="    //% group=&quot;Calculations&quot;" line93="    export function calculateAltitude(): number {" line94="        let pressure2 = readPressure();" line95="        let altitude = 44330 * (1 - Math.pow(pressure2 / seaLevelhPa, 0.1903));" line96="        return altitude;" line97="    }" line98="}" numlines="99"></mutation></block></statement></block></xml>